<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Game 3 - Tantangan Step-by-Step</title>

  <!-- SweetAlert + Skulpt -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert/dist/sweetalert.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: url("assets/images/bg.gif") center/cover no-repeat;
      opacity: 0.3;
      z-index: -1;
    }
    .container { max-width: 920px; margin: 18px auto; padding: 18px; background: #fff; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
    input { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #2DAA9E; border-radius: 6px; font-family: monospace; font-size: 15px; }
    button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 8px; }
    .run { background: #28a745; color: white; }
    .reset { background: #6c757d; color: white; }
    #mycanvas { width: 400px; height: 400px; border: 3px solid #2DAA9E; border-radius: 10px; margin: 14px auto 0; position: relative; display:block; }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:8px; }
    .meta { margin-top:8px; font-size:14px; color:#333; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Game 3 â€” Tantangan Step-by-Step</h3>
    <p>Ketik 1 baris perintah lalu tekan <b>Run</b>. Kamu hanya punya <b>3 kesempatan</b> sebelum gagal.</p>

    <div class="controls">
      <input id="command" placeholder="contoh: forward 100" autocomplete="off" />
      <button class="run" onclick="runStep()">â–¶ Run</button>
      <button class="reset" onclick="resetGame()">âŸ³ Reset</button>
    </div>

    <div class="meta">
      Langkah ke: <span id="step">0</span> / 11 <br>
      Skor: <span id="score">0</span> <br>
      Kesempatan: <span id="tries">0</span> / 3
    </div>

    <div style="display:flex; justify-content:center; align-items:center; margin-top:0px; margin-bottom: 10px;">
        <div style="position:relative; width:400px; height:400px; margin-bottom:10px;">
          <div id="mycanvas" 
               style="position:absolute; top:0; left:0; width:400px; height:400px; z-index:4;"></div>
      
          <img src="assets/images/forloop-tilemap.png"
               style="position:absolute; top:17px; left:4px; width:400px; height:400px; z-index:2; pointer-events:none;">
      
          <img src="assets/images/grid.png"
               style="position:absolute; top:10px; left:-4px; width:400px; height:400px; z-index:3; pointer-events:none; margin:8px;">
        </div>
      </div>
  </div>
  </div>

<script>
  let currentStep = 0;
  let tries = 0; // jumlah gagal
  let history = [];
  let startTime; // Tambahkan variabel untuk waktu mulai

  const validSteps = [
    "forward(100)",
    "right(90)",
    "forward(100)",
    "left(90)",
    "forward(100)",
    "right(90)",
    "forward(100)",
    "left(90)",
    "forward(100)",
    "right(90)",
    "forward(100)"
  ];

  // ambil skor dari localStorage
  let score = parseInt(localStorage.getItem("score") || "0");

  function updateScoreDisplay() {
    document.getElementById("score").innerText = score;
    localStorage.setItem("score", score);
  }

  function updateTriesDisplay() {
    document.getElementById("tries").innerText = tries;
  }

  function builtinRead(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
      throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
  }

  function parseCommand(raw) {
    if (!raw) return "";
    let s = raw.trim();
    const hasParen = /\(.*\)/.test(s);
    if (hasParen) {
      s = s.replace(/\s+/g, "");
      s = s.replace(/^([a-zA-Z_]+)\(/, (m, p1) => p1.toLowerCase() + "(");
      return s;
    } else {
      const parts = s.split(/\s+/);
      if (parts.length >= 2) {
        const cmd = parts[0].toLowerCase();
        const arg = parts.slice(1).join("");
        return `${cmd}(${arg})`;
      }
      return s.toLowerCase();
    }
  }

  async function runProgramReplay(history) {
    const imports = [
      "from turtle import *",
      "reset()",
      "shape('turtle')",
      "speed(0)",
      "penup()",
      "setposition(-150, 150)",  // ðŸ‘‰ posisi awal Game 3
      "pendown()",
      "speed(2)",
      ""
    ].join("\n");

    const body = history.length ? history.join("\n") + "\n" : "";
    const prog = imports + body;

    Sk.configure({ output: () => {}, read: builtinRead });
    (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = "mycanvas";

    return Sk.misceval.asyncToPromise(() => Sk.importMainWithBody("<stdin>", false, prog, true));
  }

  async function runStep() {
    const raw = document.getElementById("command").value;
    if (!raw.trim()) return;
    const parsed = parseCommand(raw);
    document.getElementById("command").value = "";

    if (parsed === validSteps[currentStep]) {
      history.push(parsed);
      try {
        await runProgramReplay(history);
        currentStep++;
        updateStepMeta();
        if (currentStep >= validSteps.length) {
          score += 100; // âœ… tambah skor sekali saja
          updateScoreDisplay();

          // Hitung waktu penyelesaian game ini
          const endTime = new Date().getTime();
          const gameTime = Math.round((endTime - startTime) / 1000); // Waktu dalam detik
          localStorage.setItem("game3Time", gameTime); // Simpan waktu game 3

          swal("Mantap!", "Game 3 selesai ðŸŽ‰\nSkor: " + score, "success")
            .then(() => {
              window.location.href = "finish.html"; // ðŸ‘‰ otomatis ke halaman akhir
            });
        }
      } catch (err) {
        console.error(err);
      }
    } else {
      tries++;
      updateTriesDisplay();
      if (tries >= 3) {
        swal("Gagal ðŸ˜¢", "Kamu sudah gagal 3 kali!", "error")
          .then(() => {
            window.location.href = "gagal.html";
          });
      } else {
        swal("Salah", `Perintah tidak sesuai! Kesempatan: ${tries}/3`, "error");
        resetGame();
      }
    }
  }

  function resetGame() {
    history = [];
    currentStep = 0;
    updateStepMeta();
    document.getElementById("command").value = "";
    runProgramReplay(history).catch(err => console.error(err));
    startTime = new Date().getTime(); // Reset waktu mulai setiap kali game di-reset
  }

  function updateStepMeta() {
    document.getElementById("step").innerText = currentStep;
    updateScoreDisplay();
    updateTriesDisplay();
  }

  resetGame();
  updateScoreDisplay();
  updateTriesDisplay();
</script>
</body>
</html>
